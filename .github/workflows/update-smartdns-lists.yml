name: Update SmartDNS Domain Lists

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-lists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Environment Variables
        run: |
          echo "DOMESTIC_FILE=domestic.conf" >> $GITHUB_ENV
          echo "OVERSEA_FILE=oversea.conf" >> $GITHUB_ENV
          
          echo "DIRECT_URL=https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/direct.txt" >> $GITHUB_ENV
          echo "APPLE_URL=https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/apple.txt" >> $GITHUB_ENV
          echo "PROXY_URL=https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt" >> $GITHUB_ENV
          echo "ICLOUD_URL=https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/icloud.txt" >> $GITHUB_ENV
          echo "GFW_URL=https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt" >> $GITHUB_ENV
          echo "GFWLIST_URL=https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt" >> $GITHUB_ENV

      - name: Process Domestic List (Direct + Apple + iCloud + Custom)
        run: |
          curl -sS "${DIRECT_URL}" >> "${DOMESTIC_FILE}.tmp"
          curl -sS "${APPLE_URL}" >> "${DOMESTIC_FILE}.tmp"
          curl -sS "${ICLOUD_URL}" >> "${DOMESTIC_FILE}.tmp"
          
          echo "speedtest.net" >> "${DOMESTIC_FILE}.tmp"
          echo "ookla.net" >> "${DOMESTIC_FILE}.tmp"
          
          cat "${DOMESTIC_FILE}.tmp" | \
            grep -E -v "^#|^$" | \
            sed 's/^\.//; s/^\([^.]\+\)\./\1\./' | \
            sed 's/,.*//' | \
            # --- NEW: Remove all asterisks for strict domain format ---
            sed 's/\*//g' | \
            # -----------------------------------------------------------
            grep -E '\.' | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > "${DOMESTIC_FILE}"
            
          rm -f "${DOMESTIC_FILE}.tmp"
          echo "Generated domestic list: $(wc -l < "${DOMESTIC_FILE}") domains"

      - name: Process Oversea List (Proxy + GFW + GFWList)
        run: |
          curl -sS "${PROXY_URL}" >> "${OVERSEA_FILE}.tmp"
          curl -sS "${GFW_URL}" >> "${OVERSEA_FILE}.tmp"
          
          curl -sS "${GFWLIST_URL}" | base64 -d | \
            grep -E -v "^#|^$|^\[" | \
            while read -r line; do
              domain=$(echo "${line}" | \
                sed -E 's/^\|\|//' | \
                sed -E 's/\^$//' | \
                sed -E 's/^!\s*//' | \
                sed -E 's/^\///' | \
                sed -E 's/\/.+$//' | \
                sed -E 's/@.*//' | \
                sed -E 's/\*//' | \
                sed -E 's/^http(s)?:\/\///' | \
                sed -E 's/^.+?@//' | \
                sed -E 's/:.+$//' | \
                sed -E 's/\/.+$//' | \
                tr '[:upper:]' '[:lower:]')
              
              if [ ! -z "${domain}" ] && ! echo "${domain}" | grep -qE "([0-9]{1,3}\.){3}[0-9]{1,3}"; then
                  echo "${domain}"
              fi
            done >> "${OVERSEA_FILE}.tmp"

          cat "${OVERSEA_FILE}.tmp" | \
            grep -E -v "^#|^$" | \
            sed 's/^\.//; s/^\([^.]\+\)\./\1\./' | \
            sed 's/,.*//' | \
            # --- NEW: Remove all asterisks for strict domain format ---
            sed 's/\*//g' | \
            # -----------------------------------------------------------
            grep -E '\.' | \
            tr '[:upper:]' '[:lower:]' | \
            sort -u > "${OVERSEA_FILE}"
            
          rm -f "${OVERSEA_FILE}.tmp"
          echo "Generated oversea list: $(wc -l < "${OVERSEA_FILE}") domains"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: "*.conf"
          commit_message: "Automatic: Update SmartDNS domestic/oversea lists"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
          skip_dirty_check: false
